# Change Request: Interaction Tracking Refactoring

## Change Request Information
- **CR Number**: CR-2024.02-30
- **Issue Number**: #30
- **Title**: Interaction Tracking Refactoring
- **Type**: Refactor
- **Status**: Sprint Backlog
- **Author**: Axel Janssen
- **Date Created**: 2024-02-17
- **Priority**: High
- **Impact Level**: High

## Status History
| Date | Status | Notes |
|------|--------|-------|
| 2024-02-17 | Created | Initial CR creation from existing design doc |
| 2024-02-17 | Sprint Backlog | Ready for implementation with complete specs |

## Executive Summary
This refactoring centralizes all interaction content in the Note entity while maintaining efficient timestamp tracking at both Contact and Tag levels. The key changes are:

1. **Centralization**: All interaction content and history moves to Note entities
2. **Two Note Types**: Notes become either content notes or interaction records
3. **Efficient Tracking**: Contact and Tag models keep timestamps for quick querying
4. **Proper History**: Full interaction history maintained through Notes
5. **Better Validation**: Clear rules for what makes a valid interaction record

Impact: This change simplifies the data model, improves data consistency, and provides better interaction history tracking while maintaining efficient querying for dashboards and reminders.

For detailed technical specifications and implementation details, refer to the full design document:
[Interaction Tracking Refactor Design](../../design/INTERACTION_TRACKING_REFACTOR.md)

## Requirements Analysis

### Current State
- Interaction content spread across multiple entities
- Inconsistent timestamp tracking
- No clear distinction between content notes and interaction records
- Timezone handling not standardized

### Proposed Changes
1. Base Model Changes (Phase 0)
   - Add timezone utility methods
   - Update datetime handling to use UTC
   - Add timezone validation

2. Tag Model Changes (Phase 1)
   - Remove last_contact_notes field
   - Keep last_contact timestamp
   - Update frequency tracking

3. Note Model Changes (Phase 2)
   - Add is_interaction flag
   - Add interaction_date field
   - Update validation rules
   - Implement timezone handling

4. Contact Model Changes (Phase 3)
   - Rename last_interaction_at to last_contact_at
   - Update timestamp handling
   - Add interaction history methods

### Impact Analysis
- **Functional Impact**: All interaction tracking functionality
- **Technical Impact**:
  - Domain models with datetime fields
  - ORM models and database schema
  - Repository layer implementations
- **Documentation Impact**:
  - Model documentation
  - API documentation
  - Database schema documentation
- **Test Impact**:
  - New test cases for interaction tracking
  - Updated timezone tests
  - Integration test updates

## Implementation Plan

### Phase 0: Base Model Changes
1. Add timezone utilities to BaseModel
2. Update datetime handling
3. Add validation
4. Update tests

### Phase 1: Tag Model Changes
1. Remove last_contact_notes
2. Update timestamp handling
3. Update frequency tracking
4. Update tests

### Phase 2: Note Model Changes
1. Add interaction support
2. Update validation
3. Implement timezone handling
4. Add tests

### Phase 3: Contact Model Changes
1. Rename timestamp fields
2. Update interaction tracking
3. Add history methods
4. Update tests

### Test Plan
1. Unit Tests
   - Model validation
   - Timezone handling
   - Frequency calculations
   - History tracking

2. Integration Tests
   - Complete interaction flow
   - Tag frequency tracking
   - Query performance

## Success Criteria
1. All tests pass
2. Data model is simpler
3. Interaction history is complete
4. Querying remains efficient
5. Clear separation of concerns
6. All datetime fields are timezone-aware
7. No performance degradation in queries

## Documentation Updates
1. Update model documentation
2. Update API documentation
3. Update database schema
4. Update implementation guides
5. Add migration guide

## Review and Approval
- [ ] Technical design reviewed
- [ ] Test plan approved
- [ ] Performance impact assessed
- [ ] Migration plan reviewed
- [ ] Documentation plan approved

## Implementation Notes
- Implementation will follow TDD
- Each phase must be completed and tested before moving to next
- Special attention to timezone handling
- Regular performance testing during implementation

## Post-Implementation
- Monitor query performance
- Verify timezone handling across system
- Check interaction history completeness
- Verify frequency calculations
- Document any migration issues

## Rollback Plan
1. Keep old fields during initial deployment
2. Maintain data in both old and new structures during transition
3. Script to restore old structure if needed
4. Backup all data before migration
