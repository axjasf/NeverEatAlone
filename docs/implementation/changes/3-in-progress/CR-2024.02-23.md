# Change Request: Implement Timezone Handling

## Change Request Information
- **CR Number**: CR-2024.02-23
- **Issue Number**: #23
- **Title**: Implement timezone handling
- **Type**: Feature
- **Status**: In Progress
- **Author**: Axel Janssen
- **Date Created**: 2024-02-16
- **Priority**: High
- **Impact Level**: High

## Status History
| Date | Status | Notes |
|------|--------|-------|
| 2024-02-16 | Created | Initial CR creation |
| 2024-02-16 | In Progress | Started with Template BO implementation |
| 2024-02-16 | In Progress | Completed Template BO timezone handling |
| 2024-02-16 | In Progress | Moving to Contact BO implementation |

## Executive Summary
Add comprehensive timezone support across all Business Objects, ensuring consistent handling of datetime fields in domain models, ORM layer, and repositories. This change ensures all datetime values are timezone-aware and stored in UTC.

## Requirements Analysis

### Current State
- Datetime fields lack consistent timezone handling
- Some models use naive datetimes
- Inconsistent storage format in database
- No validation for timezone presence

### Proposed Changes
- Implement timezone-aware base model
- Convert all datetime fields to use UTC
- Add timezone validation in domain models
- Update ORM layer to use UTCDateTime type
- Ensure repositories handle timezone conversion

### Impact Analysis
- **Functional Impact**: All datetime handling in the application
- **Technical Impact**:
  - Domain models with datetime fields
  - ORM models and database schema
  - Repository layer conversions
- **Documentation Impact**:
  - Implementation guides
  - API documentation
  - Development journal
- **Test Impact**:
  - Add timezone-specific tests
  - Update existing datetime tests
  - Add integration tests for timezone handling

## Documentation Updates

### Required Updates
1. **Architecture**
   - [ ] Document timezone handling strategy
   - [ ] Update data flow diagrams

2. **Data Model**
   - [x] Update Template model documentation
   - [ ] Document timezone handling in other models

3. **Implementation Details**
   - [x] Update development journal
   - [ ] Add timezone handling guide
   - [x] Update test documentation

### Version Updates
- Current Version: 2024.02.16-1
- New Version: 2024.02.16-2
- Version Update Justification: Major feature addition

## Implementation Plan

### Prerequisites
- Python datetime and zoneinfo libraries
- SQLAlchemy with timezone support
- Updated test configuration

### Implementation Steps
1. Base Implementation
   - [x] Create UTCDateTime type
   - [x] Update base ORM model
   - [x] Add timezone validation

2. Template BO Implementation
   - [x] Update domain model
   - [x] Update ORM model
   - [x] Update repository
   - [x] Add tests
   - [x] Verify implementation

3. Contact BO Implementation
   - [ ] Update last_contact field
   - [ ] Add timezone validation
   - [ ] Update tests

### Test Plan
- [x] Unit tests for UTCDateTime type
- [x] Integration tests for Template BO
- [ ] Integration tests for Contact BO
- [ ] System tests for timezone handling

## Review and Approval

### Technical Review
- [x] Code review for Template BO
- [x] Test coverage verified
- [x] Performance impact assessed
- [x] Security impact assessed

### Documentation Review
- [x] Development journal updated
- [ ] API documentation updated
- [ ] Cross-references verified
- [ ] Changelog updated

## Implementation Notes

### Progress Tracking
- Implementation Start Date: 2024-02-16
- Expected Completion: 2024-02-17
- Current Status: In Progress
- Completed Components:
  - ‚úÖ Template BO Implementation
    - Domain Layer: Timezone validation and UTC conversion
    - ORM Layer: UTCDateTime type integration
    - Repository Layer: Timezone preservation
    - Test Coverage: All scenarios verified
  - üîÑ Contact BO Implementation (Next)
    - [ ] Update last_contact field
    - [ ] Apply timezone validation
    - [ ] Add test coverage

### Technical Details
1. Template BO Implementation ‚úÖ
   - Domain Layer:
     - Pydantic validators for timezone-aware datetimes
     - Automatic UTC conversion
     - Comprehensive validation
   - ORM Layer:
     - Custom UTCDateTime type
     - Automatic UTC conversion on storage/retrieval
     - SQLite timezone handling
   - Repository Layer:
     - Leveraging UTCDateTime for automatic handling
     - All methods verified for timezone preservation
   - Test Coverage:
     - Different input timezones
     - UTC conversion verification
     - Timezone preservation checks

2. Note BO Implementation and Test Pattern Discovery üîç
   - Domain Layer:
     - Aligned with Contact BO timezone pattern
     - Added comprehensive timezone validation
   - Test Improvements:
     - Discovered critical timezone test pattern issues:
       1. Direct timezone comparisons are misleading and brittle
       2. Hour-specific DST tests break with rule changes
       3. Timezone edge cases need explicit handling
     - Developed better patterns:
       1. Always convert to UTC for moment-in-time comparisons
          ```python
          # Instead of: assert time1 < time2
          assert time1.astimezone(UTC) == time2.astimezone(UTC)
          ```
       2. Test timezone conversions explicitly
       3. Handle DST and edge cases (day boundaries, fractional offsets)
     - Impact:
       - Affects all existing timezone tests
       - Must be backported to Contact/Template BOs
       - Should be standard for remaining BOs
     - Required Actions:
       1. Document patterns in test guide
       2. Update existing tests
       3. Use in all future timezone testing

3. Contact BO Implementation (In Progress)
   - Planned Changes:
     - Update last_contact field to use UTCDateTime
     - Apply same architectural pattern as Template BO
     - Add timezone-specific tests
     - Verify timezone preservation

### Issues and Resolutions
1. SQLAlchemy session configuration:
   - Issue: Incorrect query_cls configuration causing timezone issues
   - Resolution: Removed query_cls and rely on UTCDateTime type
   - Status: ‚úÖ Resolved

### Test Status
- Total Tests: 115
- Status: ‚úÖ All Passing
- Coverage: Meeting threshold
- New Tests Added:
  - Template timezone validation
  - UTC conversion verification
  - Timezone preservation checks

### Next Steps
1. Contact BO Implementation
   - [ ] Update domain model with timezone validation
   - [ ] Integrate UTCDateTime in ORM layer
   - [ ] Update repository layer
   - [ ] Add comprehensive tests

### Lessons Learned
1. Architectural Pattern Success:
   - Implementing timezone handling vertically through layers works well
   - UTCDateTime type provides consistent behavior
   - Test-first approach helped catch edge cases

2. Test Pattern Improvements:
   - Discovered better patterns for timezone testing in Note BO
   - Direct timezone comparisons can be misleading
   - Better to compare actual moments in time after UTC conversion
   - DST-specific hour tests are too brittle
   - Future improvement: Backport these patterns to Contact/Template tests

## Post-Implementation

### Verification
- [x] Template BO tests passing
- [ ] All affected BO tests passing
- [ ] Documentation complete
- [ ] Performance verified

### Release Notes
Added comprehensive timezone handling:
- All datetime fields are now timezone-aware
- Consistent UTC storage in database
- Proper timezone conversion in repositories
- Template BO fully implemented

### Rollback Plan
1. Revert UTCDateTime type changes
2. Restore original datetime fields
3. Update tests to original state
