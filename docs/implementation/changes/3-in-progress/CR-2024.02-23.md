# Change Request: Implement Timezone Handling

## Change Request Information
- **CR Number**: CR-2024.02-23
- **Issue Number**: #23
- **Title**: Implement timezone handling
- **Type**: Feature
- **Status**: In Progress
- **Author**: Axel Janssen
- **Date Created**: 2024-02-16
- **Priority**: High
- **Impact Level**: High

## Status History
| Date | Status | Notes |
|------|--------|-------|
| 2024-02-16 | Created | Initial CR creation |
| 2024-02-16 | In Progress | Started with Template BO implementation |
| 2024-02-16 | In Progress | Completed Template BO timezone handling |
| 2024-02-16 | In Progress | Moving to Contact BO implementation |
| 2024-02-17 | In Progress | Completed Contact BO implementation |
| 2024-02-17 | In Progress | Completed Note BO improvements and test patterns |

## Executive Summary
Add comprehensive timezone support across all Business Objects, ensuring consistent handling of datetime fields in domain models, ORM layer, and repositories. This change ensures all datetime values are timezone-aware and stored in UTC.

## Requirements Analysis

### Current State
- Datetime fields lack consistent timezone handling
- Some models use naive datetimes
- Inconsistent storage format in database
- No validation for timezone presence

### Proposed Changes
- Implement timezone-aware base model
- Convert all datetime fields to use UTC
- Add timezone validation in domain models
- Update ORM layer to use UTCDateTime type
- Ensure repositories handle timezone conversion

### Impact Analysis
- **Functional Impact**: All datetime handling in the application
- **Technical Impact**:
  - Domain models with datetime fields
  - ORM models and database schema
  - Repository layer conversions
- **Documentation Impact**:
  - Implementation guides
  - API documentation
  - Development journal
- **Test Impact**:
  - Add timezone-specific tests
  - Update existing datetime tests
  - Add integration tests for timezone handling

## Documentation Updates

### Required Updates
1. **Architecture**
   - [x] Document timezone handling strategy
   - [x] Update data flow diagrams

2. **Data Model**
   - [x] Update Template model documentation
   - [x] Document timezone handling in other models

3. **Implementation Details**
   - [x] Update development journal
   - [x] Add timezone handling guide
   - [x] Update test documentation

### Version Updates
- Current Version: 2024.02.17-6
- Target Version: 2024.02.18-1
- Version Update Justification: Major feature implementation in progress - timezone handling across all BOs

## Implementation Plan

### Prerequisites
- Python datetime and zoneinfo libraries
- SQLAlchemy with timezone support
- Updated test configuration

### Implementation Steps
1. Base Implementation
   - [x] Create UTCDateTime type
   - [x] Update base ORM model
   - [x] Add timezone validation

2. Template BO Implementation
   - [x] Update domain model
   - [x] Update ORM model
   - [x] Update repository
   - [x] Add tests
   - [x] Verify implementation

3. Contact BO Implementation
   - [ ] Update last_contact field
   - [ ] Add timezone validation
   - [ ] Update tests

### Test Plan
- [x] Unit tests for UTCDateTime type
- [x] Integration tests for Template BO
- [ ] Integration tests for Contact BO
- [ ] System tests for timezone handling

## Review and Approval

### Technical Review
- [x] Code review for Template BO
- [x] Test coverage verified
- [x] Performance impact assessed
- [x] Security impact assessed

### Documentation Review
- [x] Development journal updated
- [ ] API documentation updated
- [ ] Cross-references verified
- [ ] Changelog updated

## Implementation Notes

### Progress Tracking
- Implementation Start Date: 2024-02-16
- Expected Completion: 2024-02-18
- Current Status: In Progress
- Completed Components:
  - ‚úÖ Template BO Implementation
    - Domain Layer: Timezone validation and UTC conversion
    - ORM Layer: UTCDateTime type integration
    - Repository Layer: Timezone preservation
    - Test Coverage: All scenarios verified
  - ‚úÖ Contact BO Implementation
    - Domain Layer: Last contact field updated
    - Test Coverage: All patterns implemented
  - ‚úÖ Note BO Implementation
    - Enhanced timezone handling
    - Improved test patterns
    - Comprehensive documentation
  - üîÑ Remaining BOs (In Progress)
    - Statement BO: Not started
    - Reminder BO: Not started
    - Tag BO: Not started

### Technical Details
1. Template BO Implementation ‚úÖ
   - Domain Layer:
     - Pydantic validators for timezone-aware datetimes
     - Automatic UTC conversion
     - Comprehensive validation
   - ORM Layer:
     - Custom UTCDateTime type
     - Automatic UTC conversion on storage/retrieval
     - SQLite timezone handling
   - Repository Layer:
     - Leveraging UTCDateTime for automatic handling
     - All methods verified for timezone preservation
   - Test Coverage:
     - Different input timezones
     - UTC conversion verification
     - Timezone preservation checks

2. Note BO Implementation and Test Pattern Discovery üîç
   - Domain Layer:
     - Aligned with Contact BO timezone pattern
     - Added comprehensive timezone validation
   - Test Improvements:
     - Discovered critical timezone test pattern issues:
       1. Direct timezone comparisons are misleading and brittle
       2. Hour-specific DST tests break with rule changes
       3. Timezone edge cases need explicit handling
     - Developed better patterns:
       1. Always convert to UTC for moment-in-time comparisons
          ```python
          # Instead of: assert time1 < time2
          assert time1.astimezone(UTC) == time2.astimezone(UTC)
          ```
       2. Test timezone conversions explicitly
       3. Handle DST and edge cases (day boundaries, fractional offsets)

   - Test Patterns by Layer:
     1. Domain Layer Tests:
        - Timezone validation:
          ```python
          # Reject naive datetimes
          with pytest.raises(ValueError, match="must be timezone-aware"):
              Note(contact_id=id, interaction_date=naive_date)

          # Validate future dates across timezones
          future_ny_time = datetime.now(ny_tz) + timedelta(days=1)
          with pytest.raises(ValueError, match="cannot be in the future"):
              Note(contact_id=id, interaction_date=future_ny_time)
          ```
        - Timezone conversion:
          ```python
          # Verify conversion to UTC
          sydney_time = datetime.now(sydney_tz)
          note = Note(contact_id=id, interaction_date=sydney_time)
          assert note.interaction_date.tzinfo == UTC
          assert note.interaction_date == sydney_time.astimezone(UTC)
          ```
        - Edge cases:
          - DST transitions
          - Day boundaries
          - Fractional hour offsets

     2. ORM Layer Tests:
        - Storage integrity:
          ```python
          # Verify UTC storage
          note = NoteORM(interaction_date=sydney_time)
          db_session.add(note)
          db_session.commit()
          db_session.refresh(note)
          assert note.interaction_date.tzinfo == UTC
          ```
        - Timezone preservation:
          ```python
          # Same moment from different timezones
          ny_time = sydney_time.astimezone(ny_tz)
          note_ny = NoteORM(interaction_date=ny_time)
          assert note_ny.interaction_date == note_sydney.interaction_date
          ```
        - Audit fields:
          ```python
          # created_at/updated_at timezone handling
          assert note.created_at.tzinfo == UTC
          assert note.updated_at.tzinfo == UTC
          ```

     3. Repository Layer Tests (To Be Added):
        - Query filtering with timezones
        - Range queries across DST boundaries
        - Sorting by datetime fields
        - Timezone-aware aggregations

   - Key Improvements Over Template/Contact Tests:
     1. More explicit timezone conversion verification
     2. Better edge case coverage
     3. Clearer separation of concerns by layer
     4. More comprehensive DST handling
     5. Audit field timezone verification

   - Harmonization Opportunities:
     1. Domain Layer:
        - [ ] Backport DST transition tests
        - [ ] Add fractional offset tests
        - [ ] Standardize timezone validation messages

     2. ORM Layer:
        - [ ] Add explicit UTC storage tests
        - [ ] Add timezone preservation tests
        - [ ] Standardize audit field tests

     3. Repository Layer:
        - [ ] Define standard timezone query tests
        - [ ] Add DST-aware range query tests
        - [ ] Standardize datetime sorting tests

   - Impact:
     - Affects all existing timezone tests
     - Must be backported to Contact/Template BOs
     - Should be standard for remaining BOs
     - Provides template for future BO implementations

   - Required Actions:
     1. Document patterns in test guide
     2. Update existing tests
     3. Use in all future timezone testing

3. Contact BO Implementation (In Progress)
   - Planned Changes:
     - Update last_contact field to use UTCDateTime
     - Apply same architectural pattern as Template BO
     - Add timezone-specific tests
     - Verify timezone preservation

### Issues and Resolutions
1. SQLAlchemy session configuration:
   - Issue: Incorrect query_cls configuration causing timezone issues
   - Resolution: Removed query_cls and rely on UTCDateTime type
   - Status: ‚úÖ Resolved

### Test Status
- Total Tests: 115
- Status: ‚úÖ All Passing
- Coverage: Meeting threshold
- New Tests Added:
  - Template timezone validation
  - UTC conversion verification
  - Timezone preservation checks

### Next Steps
1. Contact BO Implementation
   - [ ] Update domain model with timezone validation
   - [ ] Integrate UTCDateTime in ORM layer
   - [ ] Update repository layer
   - [ ] Add comprehensive tests

### Lessons Learned
1. Architectural Pattern Success:
   - Implementing timezone handling vertically through layers works well
   - UTCDateTime type provides consistent behavior
   - Test-first approach helped catch edge cases

2. Test Pattern Improvements:
   - Discovered better patterns for timezone testing in Note BO
   - Direct timezone comparisons can be misleading
   - Better to compare actual moments in time after UTC conversion
   - DST-specific hour tests are too brittle
   - Future improvement: Backport these patterns to Contact/Template tests

## Post-Implementation

### Verification
- [x] Template BO tests passing
- [ ] All affected BO tests passing
- [ ] Documentation complete
- [ ] Performance verified

### Release Notes
Added comprehensive timezone handling:
- All datetime fields are now timezone-aware
- Consistent UTC storage in database
- Proper timezone conversion in repositories
- Template BO fully implemented

### Rollback Plan
1. Revert UTCDateTime type changes
2. Restore original datetime fields
3. Update tests to original state
